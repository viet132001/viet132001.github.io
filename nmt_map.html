<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Vị trí</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.2.2/dist/ol.js"></script>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.2.2/ol.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      background: #ddd;
    }

    .mapboxgl-marker {
      border-radius: 50%;
    }

    #info,
    #info-online,
    #info-online-offline,
    #info-plan {
      position: absolute;
      padding: 4px;
      font-family: 'Open Sans', sans-serif;
      font-size: 12px;
      width: 200px;
      min-height: 20px;
      max-height: 90vh;
      overflow-y: scroll;
      background: rgba(0, 0, 0, 0.5);
    }

    #info {
      top: 200px;
      left: 50px;
    }

    #info-online {
      top: 0;
      left: 205px;
    }

    #info-online-offline {
      top: 0;
      left: 410px;
    }

    #info-plan {
      top: 0;
      left: 617px;
    }

    .hidden {
      display: none;
    }

    #hide-button {
      position: absolute;
      top: 150px;
      height: 30px;
      z-index: 1;
      width: 155px;
      background-color: white;
      padding: 5px 10px;
      font-size: 1rem;
      cursor: pointer;
      transform: rotate(-90deg);
      transform-origin: top left;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

  <div id="map"></div>

  <script>
    const url = new URL(document.location.toString());
    const parent_code = url.searchParams.get('parent_code');
    const viewMap = url.searchParams.get('viewMap');
    const dataSale = [];
    let lat = url.searchParams.get('lat') || 10.760948;
    let long = url.searchParams.get('long') || 106.705611;

    lat = parseFloat(lat);
    long = parseFloat(long);

    let first = true;
    let visited = 0;
    let notVisited = 0;
    let order = 0;
    let popup = null;
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.basemaps.cartocdn.com/gl/voyager-nolabels-gl-style/style.json', // thay URL bạn thích
  center: [106.705611, 10.760948],
  zoom: 11,
  pitch: 30,
  bearing: -10,
  antialias: true
});
// map.addControl(new maplibregl.NavigationControl(), 'top-right');
// map.addControl(new maplibregl.ScaleControl({ unit: 'metric' }));
    $(document).ready(function () {
      map.loadImage(`../img/online.png`, (error, image) => {
        if (!error && !map.hasImage(`avatarO`)) map.addImage(`avatarO`, image);
      });
      map.loadImage(`../img/offline.png`, (error, image) => {
        if (!error && !map.hasImage(`avatarOF`)) map.addImage(`avatarOF`, image);
      });
      map.loadImage(`../img/logo.png`, (error, image) => {
        if (!error && !map.hasImage(`logo`)) map.addImage(`logo`, image);
      });

      function btnGetData() {
        $.ajax({
          url: `https://api-nmt.newweb.vn/v1/report-hierarchical-trees?parent_code=${parent_code}&type=USER&is_search=1&limit=999`,
          type: 'GET',
          dataType: 'json',
          headers: {
            'Authorization': 'Bearer 226b116857c2788c685c66bf601222b56bdc3751b4f44b944361e84b2b1f002b'
          },
          success: function (data) {
            data.data.forEach(newElement => {
              const index = dataSale.findIndex(e => e.id === newElement.id);
              if (index >= 0) dataSale[index] = newElement;
              else dataSale.push(newElement);
            });

            if (first) {
              dataSale.forEach(e => {
                if (e.code === parent_code && e.lat) {
                  map.flyTo({
                    center: [e.long, e.lat],
                    speed: 1,
                    zoom: 16,
                    easing(t) {
                      if (t === 1) map.setPitch(30);
                      return t;
                    }
                  });
                }
              });
              getDataPlan();
              first = false;
            }

            dataSale.forEach(element => {
              const sourceId = `${element.code}`;
              if (map.getLayer(sourceId)) map.removeLayer(sourceId);
              if (map.getSource(sourceId)) map.removeSource(sourceId);

              const stt = element.is_online === 1 ? 'Đang online' : element.time_diff;

              map.addSource(sourceId, {
                type: 'geojson',
                data: {
                  type: 'FeatureCollection',
                  features: [{
                    type: 'Feature',
                    properties: {
                      description:
                        `<strong>${element.name}</strong><br/>Thiết bị: <strong>${element.device_name}</strong><br/>Doanh số tháng: <strong>${element.total_sale_formatted}</strong><br/>Doanh số ngày: <strong>${element.total_sale_day_formatted}</strong><br/>Tổng số đơn: <strong>${element.order_count}</strong><br/>Đơn hàng hôm nay: <strong>${element.order_count_day}</strong><br/>Viếng thăm hôm nay: <strong>${element.total_visit_day}</strong><br/>Trạng thái: <strong>${stt}</strong>`
                    },
                    geometry: {
                      type: 'Point',
                      coordinates: [element.long?? 105.047641
                      , element.lat??11.732011]
                    }
                  }]
                }
              });

              map.addLayer({
                id: sourceId,
                type: 'symbol',
                source: sourceId,
                layout: {
                  'icon-image': element.is_online === 1 ? 'avatarO' : 'avatarOF',
                  'icon-size': element.type === 'store' ? 0.2 : 0.8,
                  'text-field': element.is_online === 1 ? element.name : `${element.name} ${element.time_diff}`,
                  'text-offset': [0, 2],
                  'text-anchor': 'top',
                  'text-size': 12
                },
                paint: {
                  'text-color': element.status === 'NEW' ? '#DF5E36' : element.status === 'CHECKIN' ? '#23EDED' : element.status === 'CHECKOUT' ? '#96E14A' : '#FA0B0B',
                  'text-halo-color': '#fff',
                  'text-halo-width': 2
                }
              });

              map.on('click', sourceId, (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const description = e.features[0].properties.description;

                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                if (popup) popup.remove();
                popup = new maplibregl.Popup().setLngLat(coordinates).setHTML(description).addTo(map);
              });
            });
          }
        });

        setTimeout(btnGetData, 30000);
      }

      btnGetData();
    });

    function getDataPlan() {
      if (dataSale.length === 0) return;

      const dataSaleCode = dataSale.map(e => e.code);

      $.ajax({
        url: `https://api-nmt.newweb.vn/v1/client/get-plan-now-by-saleman?limit=999`,
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({ arr_saleman_code: dataSaleCode }),
        headers: {
          'Authorization': 'Bearer 226b116857c2788c685c66bf601222b56bdc3751b4f44b944361e84b2b1f002b'
        },
        success: function (data) {
          data.data.forEach(element => {
            const sourceId = element.shop_code;

            if (map.getLayer(sourceId)) map.removeLayer(sourceId);
            if (map.getSource(sourceId)) map.removeSource(sourceId);

            let imgs = '';
            (element.images || []).forEach(img => {
              imgs += `<img src="https://media-daithuan.newweb.vn/file/${img.id}" style="width: 100px; height: 100px;" />`;
            });

            map.addSource(sourceId, {
              type: 'geojson',
              data: {
                type: 'FeatureCollection',
                features: [{
                  type: 'Feature',
                  properties: {
                    description: `<strong>${element.shop_name}</strong><br/>${imgs}<br/>Trạng thái: <strong>${element.status}</strong>`
                  },
                  geometry: {
                    type: 'Point',
                    coordinates: [element.shop_long, element.shop_lat]
                  }
                }]
              }
            });

            map.addLayer({
              id: sourceId,
              type: 'symbol',
              source: sourceId,
              layout: {
                'icon-image': 'logo',
                'icon-size': 0.3,
                'text-field': element.shop_name,
                'text-offset': [0, 2],
                'text-anchor': 'top',
                'text-size': 10
              },
              paint: {
                'text-color': element.status === 'NEW' ? '#DF5E36' : element.status === 'CHECKIN' ? '#23EDED' : element.status === 'CHECKOUT' ? '#96E14A' : '#FA0B0B',
                'text-halo-color': '#fff',
                'text-halo-width': 2
              }
            });

            map.on('click', sourceId, (e) => {
              const coordinates = e.features[0].geometry.coordinates.slice();
              const description = e.features[0].properties.description;

              while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
              }

              if (popup) popup.remove();
              popup = new maplibregl.Popup().setLngLat(coordinates).setHTML(description).addTo(map);
            });
          });
        }
      });
    }
  </script>

  <button id="btnGetData">Gọi API</button>
  <div id="output"></div>

</body>

</html>
